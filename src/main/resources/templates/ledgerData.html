<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Ledger List</title>

    <!-- Bootstrap & DataTables CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">

    <style>
        .table-responsive {
            overflow-x: auto;
            width: 100%;
        }

        #ledgerTable {
            min-width: 1800px;
    
        }

        .table-responsive::-webkit-scrollbar {
            height: 6px;
        }
        .dt-buttons {
            display: flex !important;
        }

        .table-responsive::-webkit-scrollbar-thumb {
            background: #bbb;
            border-radius: 4px;
        }

        #exportButtonsContainer .dt-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .dt-button {
            padding: 6px 12px;
            font-size: 14px;
        }

        .dt-button.buttons-excel {
            background-color: #28a745 !important;
            color: white !important;
            border-color: #28a745 !important;
        }

        .dt-button.buttons-excel:hover {
            background-color: #218838 !important;
            border-color: #1e7e34 !important;
        }

        /* Inline editing styles */
        .editable {
            cursor: pointer;
            position: relative;
        }

        .editable:hover {
            background-color: #f8f9fa;
        }

        .editable:after {
            content: "âœŽ";
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .editable:hover:after {
            opacity: 1;
        }

        /* Hide pencil icon for Group ID and SubGroup ID columns */
        #ledgerTable td:nth-child(3):after,
        #ledgerTable td:nth-child(5):after {
            display: none !important;
        }

        .editing {
            background-color: #fff3cd !important;
        }

        .editable-input {
            width: 100%;
            padding: 4px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }

        .editable-select {
            width: 100%;
            padding: 4px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }

        .wizard {
            margin: 20px 0;
        }
        .wizard-progress {
            margin-bottom: 30px;
        }
        .wizard .nav-pills {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        .wizard .nav-pills .nav-link {
            padding: 8px 15px;
            border-radius: 4px;
            background-color: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
        }
        .wizard .nav-pills .nav-link.active {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }
        .wizard .progress {
            height: 4px;
            margin-bottom: 10px;
        }
        .tab-pane {
            padding: 20px 0;
        }
        .form-label {
            font-weight: 500;
        }
        .form-label:after {
            content: " *";
            color: red;
            display: none;
        }
        .form-label[for]:has(+ input[required]):after,
        .form-label[for]:has(+ select[required]):after {
            display: inline;
        }
    </style>


</head>
<body>
<div class="container mt-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4>Ledger Records</h4>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addLedgerModal">
            Add New Ledger
        </button>
    </div>
    <div id="exportButtonsContainer" class="d-flex gap-2 mt-3"></div>
    <div class="table-responsive mb-5" style="overflow-x: auto; ">
        <div style="min-width: 1800px;">
            <div class="row mt-3 mb-3 ms-3">
                <div class="col-md-3 d-flex flex-wrap" style="gap: 10px;">
                    <input type="text" id="ledgerNameSearch" class="form-control" placeholder="Search Ledger Name">
                </div>
                <div class="col-md-3">
                    <input type="text" id="groupNameSearch" class="form-control" placeholder="Search Group Name">
                </div>
                <div class="col-md-3">
                    <input type="text" id="subGroupNameSearch" class="form-control" placeholder="Search SubGroup Name">
                </div>
                <div class="col-md-3">
                    <select id="apVersionDropdown" class="form-control">
                        <option value="">All AP Versions</option>
                        <option th:each="ap : ${apVersions}" th:value="${ap}" th:text="${ap}"></option>
                    </select>
                </div>
            </div>

            <table id="ledgerTable" class="table table-bordered table-striped">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Ledger Name</th>
                    <th>Group ID</th>
                    <th>Group Name</th>
                    <th>SubGroup ID</th>
                    <th>SubGroup Name</th>
                    <th>Created Date</th>
                    <th>Is Active</th>
                    <th>Is Deleted</th>
                    <th>Updated Date</th>
                    <th>Version</th>
                    <th>Code</th>
                    <th>Is Group</th>
                    <th>Is Ledger</th>
                    <th>Is SubGroup</th>
                    <th>Created By</th>
                    <th>Updated By</th>
                    <th>Ledger Type ID</th>
                    <th>Parent ID</th>
                    <th>Menu ID</th>
                    <th>Serial Number</th>
                    <th>Formula</th>
                    <th>Is Editable</th>
                    <th>Depreciation Ledger ID</th>
                    <th>Accumulated Depreciation ID</th>
                    <th>Is Optional</th>
                    <th>AP Version</th>
                    <th>FSA Area ID</th>
                    <th>Ledger Header</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="ledger : ${ledgers}">
                    <td th:text="${ledger.id}"></td>
                    <td th:text="${ledger.ledgerName}"></td>
                    <td th:text="${ledger.groupId}"></td>
                    <td th:text="${ledger.groupName}"></td>
                    <td th:text="${ledger.subGroupId}"></td>
                    <td th:text="${ledger.subGroupName}"></td>
                    <td th:text="${ledger.createdDate}"></td>
                    <td th:text="${ledger.isActive}"></td>
                    <td th:text="${ledger.isDeleted}"></td>
                    <td th:text="${ledger.updatedDate}"></td>
                    <td th:text="${ledger.version}"></td>
                    <td th:text="${ledger.code}"></td>
                    <td th:text="${ledger.isGroup}"></td>
                    <td th:text="${ledger.isLedger}"></td>
                    <td th:text="${ledger.isSubGroup}"></td>
                    <td th:text="${ledger.createdBy}"></td>
                    <td th:text="${ledger.updatedBy}"></td>
                    <td th:text="${ledger.ledgerTypeId}"></td>
                    <td th:text="${ledger.parentId}"></td>
                    <td th:text="${ledger.tbMenuId}"></td>
                    <td th:text="${ledger.serialNumber}"></td>
                    <td th:text="${ledger.formula}"></td>
                    <td th:text="${ledger.isEditable}"></td>
                    <td th:text="${ledger.depreciationLedgerId}"></td>
                    <td th:text="${ledger.accumulatedDepreciationId}"></td>
                    <td th:text="${ledger.isOptional}"></td>
                    <td th:text="${ledger.apVersion}"></td>
                    <td th:text="${ledger.fsaAreaId}"></td>
                    <td th:text="${ledger.ledgerHeader}"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add New Ledger Modal -->
    <div class="modal fade" id="addLedgerModal" tabindex="-1" aria-labelledby="addLedgerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addLedgerModalLabel">Add New Ledgerr</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="wizard">
                        <div class="wizard-progress">
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <ul class="nav nav-pills">
                                <li class="nav-item">
                                    <a class="nav-link active" href="#step1" data-bs-toggle="pill">Basic Info</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#step2" data-bs-toggle="pill">Type & Status</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#step3" data-bs-toggle="pill">Additional Info</a>
                                </li>
                            </ul>
                        </div>
                        <div class="tab-content">
                            <!-- Step 1: Basic Information -->
                            <div class="tab-pane fade show active" id="step1">
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label for="ledgerName" class="form-label">Ledger Name *</label>
                                        <input type="text" class="form-control" id="ledgerName" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="code" class="form-label">Code</label>
                                        <input type="text" class="form-control" id="code" maxlength="16">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="version" class="form-label">Version *</label>
                                        <input type="number" class="form-control" id="version" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="apVersion" class="form-label">AP Version *</label>
                                        <input type="number" class="form-control" id="apVersion" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="ledgerHeader" class="form-label">Ledger Header</label>
                                        <input type="text" class="form-control" id="ledgerHeader" maxlength="100">
                                    </div>
                                </div>
                            </div>

                            <!-- Step 2: Type & Status -->
                            <div class="tab-pane fade" id="step2">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="isActive" class="form-label">Is Active *</label>
                                        <select class="form-select" id="isActive" required>
                                            <option value="true" selected>Yes</option>
                                            <option value="false">No</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="isDeleted" class="form-label">Is Deleted *</label>
                                        <select class="form-select" id="isDeleted" required>
                                            <option value="false" selected>No</option>
                                            <option value="true">Yes</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="isGroup" class="form-label">Is Group *</label>
                                        <select class="form-select" id="isGroup" required>
                                            <option value="false" selected>No</option>
                                            <option value="true">Yes</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="isLedger" class="form-label">Is Ledger *</label>
                                        <select class="form-select" id="isLedger" required>
                                            <option value="true" selected>Yes</option>
                                            <option value="false">No</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="isSubGroup" class="form-label">Is SubGroup *</label>
                                        <select class="form-select" id="isSubGroup" required>
                                            <option value="false" selected>No</option>
                                            <option value="true">Yes</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="isEditable" class="form-label">Is Editable *</label>
                                        <select class="form-select" id="isEditable" required>
                                            <option value="true" selected>Yes</option>
                                            <option value="false">No</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="isOptional" class="form-label">Is Optional *</label>
                                        <select class="form-select" id="isOptional" required>
                                            <option value="false" selected>No</option>
                                            <option value="true">Yes</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 3: Additional Information -->
                            <div class="tab-pane fade" id="step3">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="createdBy" class="form-label">Created By *</label>
                                        <input type="number" class="form-control" id="createdBy" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="updatedBy" class="form-label">Updated By *</label>
                                        <input type="number" class="form-control" id="updatedBy" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="ledgerTypeId" class="form-label">Ledger Type ID</label>
                                        <input type="number" class="form-control" id="ledgerTypeId">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="parentId" class="form-label">Parent ID</label>
                                        <input type="number" class="form-control" id="parentId">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="tbMenuId" class="form-label">Menu ID</label>
                                        <input type="number" class="form-control" id="tbMenuId">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="serialNumber" class="form-label">Serial Number</label>
                                        <input type="number" class="form-control" id="serialNumber">
                                    </div>
                                    <div class="col-md-12 mb-3">
                                        <label for="formula" class="form-label">Formula</label>
                                        <input type="text" class="form-control" id="formula">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="depreciationLedgerId" class="form-label">Depreciation Ledger ID</label>
                                        <input type="number" class="form-control" id="depreciationLedgerId">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="accumulatedDepreciationId" class="form-label">Accumulated Depreciation ID</label>
                                        <input type="number" class="form-control" id="accumulatedDepreciationId">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="fsaAreaId" class="form-label">FSA Area ID</label>
                                        <input type="number" class="form-control" id="fsaAreaId">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">Previous</button>
                    <button type="button" class="btn btn-primary" id="nextBtn">Next</button>
                    <button type="button" class="btn btn-success" id="saveLedgerBtn" style="display: none;">Save Ledger</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
        var table = $('#ledgerTable').DataTable({
            dom: 'Bfrtip',
            buttons: [
                {
                    extend: 'excelHtml5',
                    exportOptions: {
                        columns: ':visible',
                        modifier: {
                            search: 'applied',
                            order: 'applied'
                        }
                    }
                }
            ],
            scrollX: true,
            paging: true,
            pageLength: 10,
            bInfo: true,
            searching: true,
            autoWidth: false,
            columnDefs: [
                { width: "150px", targets: 1 },  // Ledger Name
                { width: "150px", targets: 3 },  // Group Name
                { width: "150px", targets: 5 },  // SubGroup Name
                { width: "200px", targets: 21 },  // Formula
                { 
                    targets: [2, 4],  // Group ID and SubGroup ID columns
                    className: 'editable'
                },
                { 
                    targets: [0, 1, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28],
                    className: 'editable show-pencil'
                }
            ]
        });
    $('#ledgerTable').DataTable().buttons().container().appendTo('#exportButtonsContainer');
        // Ledger Name Filter (column 1)
        $('#ledgerNameSearch').on('keyup', function () {
            table.column(1).search(this.value).draw();
        });

        // Group Name Filter (column 3)
        $('#groupNameSearch').on('keyup', function () {
            table.column(3).search(this.value).draw();
        });

        // SubGroup Name Filter (column 5)
        $('#subGroupNameSearch').on('keyup', function () {
            table.column(5).search(this.value).draw();
        });

        // AP Version Dropdown Filter (column 26, 0-based index)
        $('#apVersionDropdown').on('change', function () {
            table.column(26).search(this.value).draw();
        });

        // Inline editing functionality
        $('#ledgerTable').on('click', 'td.editable', function() {
            var cell = $(this);
            var column = table.cell(this).index().column;
            var row = table.cell(this).index().row;
            var data = table.cell(this).data();
            
            // Skip if it's a group or subgroup column
            if ([2, 3, 4, 5].includes(column)) {
                return;
            }

            cell.addClass('editing');
            
            // Create input based on column type
            var input;
            if ([7, 8, 12, 13, 14, 22, 25].includes(column)) { // Boolean columns
                input = $('<select class="editable-select"><option value="true">true</option><option value="false">false</option></select>');
                input.val(data);
            } else {
                input = $('<input type="text" class="editable-input">');
                input.val(data);
            }

            cell.html(input);
            input.focus();

            // Handle input completion
            function completeEdit() {
                var newValue = input.val();
                cell.removeClass('editing');
                
                // Log the data being sent
                var requestData = {
                    id: table.cell(row, 0).data(),
                    column: table.column(column).header().textContent,
                    value: newValue
                };
                console.log('Sending update request:', requestData);
                
                // Make the AJAX call to update the backend
                $.ajax({
                    url: '/api/ledger/update',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(requestData),
                    success: function(response) {
                        console.log('Update response:', response);
                        if (response.success) {
                            // Update the cell data only if the backend update was successful
                            table.cell(cell).data(newValue);
                            // Show success message
                            alert('Update successful!');
                        } else {
                            // Revert the change if the backend update failed
                            table.cell(cell).data(data);
                            alert('Update failed: ' + (response.message || 'Unknown error'));
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Update error:', {
                            status: status,
                            error: error,
                            response: xhr.responseText
                        });
                        // Revert the change if there was an error
                        table.cell(cell).data(data);
                        alert('Update failed: ' + (xhr.responseJSON?.message || error));
                    }
                });
            }

            // Handle Enter key and blur
            input.on('keypress', function(e) {
                if (e.which === 13) {
                    completeEdit();
                }
            });

            input.on('blur', function() {
                completeEdit();
            });
        });

        // Wizard functionality
        let currentStep = 1;
        const totalSteps = 3;

        function updateWizardUI() {
            // Update progress bar
            const progress = (currentStep / totalSteps) * 100;
            $('.progress-bar').css('width', progress + '%');

            // Update navigation pills
            $('.nav-pills .nav-link').removeClass('active');
            $(`.nav-pills .nav-link[href="#step${currentStep}"]`).addClass('active');

            // Update tab content
            $('.tab-pane').removeClass('show active');
            $(`#step${currentStep}`).addClass('show active');

            // Update buttons
            $('#prevBtn').toggle(currentStep > 1);
            $('#nextBtn').toggle(currentStep < totalSteps);
            $('#saveLedgerBtn').toggle(currentStep === totalSteps);
        }

        $('#nextBtn').click(function() {
            if (currentStep < totalSteps) {
                currentStep++;
                updateWizardUI();
            }
        });

        $('#prevBtn').click(function() {
            if (currentStep > 1) {
                currentStep--;
                updateWizardUI();
            }
        });

        // Handle new ledger form submission
        $('#saveLedgerBtn').click(function() {
            // Validate required fields
            let isValid = true;
            $('input[required], select[required]').each(function() {
                if (!$(this).val()) {
                    isValid = false;
                    $(this).addClass('is-invalid');
                } else {
                    $(this).removeClass('is-invalid');
                }
            });

            if (!isValid) {
                alert('Please fill in all required fields');
                return;
            }

            const formData = {
                ledgerName: $('#ledgerName').val(),
                isActive: $('#isActive').val() === 'true',
                isDeleted: $('#isDeleted').val() === 'true',
                version: parseInt($('#version').val()),
                code: $('#code').val(),
                isGroup: $('#isGroup').val() === 'true',
                isLedger: $('#isLedger').val() === 'true',
                isSubGroup: $('#isSubGroup').val() === 'true',
                createdBy: parseInt($('#createdBy').val()),
                updatedBy: parseInt($('#updatedBy').val()),
                ledgerTypeId: $('#ledgerTypeId').val() ? parseInt($('#ledgerTypeId').val()) : null,
                parentId: $('#parentId').val() ? parseInt($('#parentId').val()) : null,
                tbMenuId: $('#tbMenuId').val() ? parseInt($('#tbMenuId').val()) : null,
                serialNumber: $('#serialNumber').val() ? parseInt($('#serialNumber').val()) : null,
                formula: $('#formula').val(),
                isEditable: $('#isEditable').val() === 'true',
                depreciationLedgerId: $('#depreciationLedgerId').val() ? parseInt($('#depreciationLedgerId').val()) : null,
                accumulatedDepreciationId: $('#accumulatedDepreciationId').val() ? parseInt($('#accumulatedDepreciationId').val()) : null,
                isOptional: $('#isOptional').val() === 'true',
                apVersion: parseInt($('#apVersion').val()),
                fsaAreaId: $('#fsaAreaId').val() ? parseInt($('#fsaAreaId').val()) : null,
                ledgerHeader: $('#ledgerHeader').val()
            };

            $.ajax({
                url: '/api/ledger/create',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    if (response.success) {
                        alert('Ledger created successfully!');
                        $('#addLedgerModal').modal('hide');
                        location.reload();
                    } else {
                        alert('Failed to create ledger: ' + (response.message || 'Unknown error'));
                    }
                },
                error: function(xhr, status, error) {
                    alert('Error creating ledger: ' + (xhr.responseJSON?.message || error));
                }
            });
        });

        // Initialize wizard UI
        updateWizardUI();
    });

    </script>


</body>
</html>
